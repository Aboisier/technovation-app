<%
  ambassador ||= false
  user ||= ambassador
%>

<% if pitch_event.divisions.include?(Division.public_send(division)) %>
  <div class="participants-list">
    <table class="ra-participants-list teams">
      <thead>
        <tr>
          <th>Team</th>
          <th>Submission</th>

          <% if ambassador %>
            <th>Last message</th>
            <th>Unsent message</th>
            <th>New message</th>
            <th>Remove</th>
          <% end %>
        </tr>
      </thead>

      <tbody>
        <% if ambassador %>
          <tr>
            <td colspan="6" class="add-participant">
              <%= link_to fa_icon(
                  "plus",
                  text: "Add a #{division.to_s.titleize} team to this event"
                ),
                new_regional_ambassador_regional_pitch_event_participation_path(
                  event_id: pitch_event.id,
                  participant_type: "Team",
                  division: division
                ),
                data: { modal_trigger: "participants-list-#{division}-teams" } %>

              <div id="participants-list-<%= division %>-teams"
                  class="modalify modalify--fixed"
                  data-heading="Select <%= division.to_s.titleize %> Teams">
                <%= render 'regional_ambassador/regional_pitch_event_participations/new',
                  anchor: anchor,
                  division: division,
                  participant_type: "Team",
                  event: pitch_event,
                  participants: instance_variable_get("@#{division}_team_participants") %>
              </div>
            </td>
          </tr>
        <% end %>

        <% if pitch_event.teams.public_send(division).any? %>
          <% pitch_event.teams.public_send(division).order("teams.name").each do |team| %>
            <tr>
              <td class="primary-col">
                <%= link_to team.name, [user.type_name, team] %>
                <% if ambassador %>
                  <small class="team-list-action">
                    <%= link_to fa_icon('gavel', text: 'Assign to a judge'),
                      new_regional_ambassador_judge_assignment_path(
                        team_id: team.id,
                        referring_anchor: anchor
                      ) %>
                  </small>

                  <% team.judge_assignments.each do |assignment| %>
                    <small class="team-list-action">
                      <%= link_to fa_icon(
                          'times',
                          text: "Unassign from judge: #{assignment.judge_profile.full_name}"
                        ),
                        regional_ambassador_judge_assignment_path(
                          assignment,
                          http_referer: request.fullpath,
                          referring_anchor: anchor
                        ),
                        data: {
                          method: :delete,
                          confirm: "You are REMOVING #{team.name} from Judge: #{assignment.judge_profile.full_name}",
                        } %>
                    </small>
                  <% end %>
                <% end %>
              </td>

              <td>
                <% if team.submission.present? %>
                  <%= link_to fa_icon('file-code-o', text: team.submission.app_name || "no name yet"),
                    app_path(team.submission),
                    target: :_blank %>
                <% else %>
                  (submission not begun!)
                <% end %>
              </td>

              <% if ambassador %>
                <td>
                  <% if ambassador.messages.sent.flat_map(&:recipient).include?(team) %>
                    sent <%= time_ago_in_words ambassador.messages.sent.select { |m| m.recipient == team }.last.sent_at %> ago
                  <% else %>
                    none
                  <% end %>
                </td>

                <td>
                  <% if ambassador.messages.unsent.flat_map(&:recipient).include?(team) %>
                    <%= link_to fa_icon('eye', text: 'review unsent message'),
                      [:regional_ambassador, ambassador.messages.unsent.detect { |m| m.recipient == team }] %>
                  <% else %>
                    none
                  <% end %>
                </td>

                <td>
                  <%= link_to fa_icon('pencil-square-o', text: 'compose new'),
                    new_regional_ambassador_message_path(
                      recipient_type: "Team",
                      recipient_id: team.id,
                      regarding_id: pitch_event.id,
                      regarding_type: "RegionalPitchEvent"
                    ),
                    data: {
                      modal_trigger: "send-message-#{team.id}"
                    } %>

                  <div id="send-message-<%= team.id %>"
                        class="modalify modalify--fixed"
                        data-heading="Send a message to <%= team.name %>">
                    <%= render 'regional_ambassador/messages/new',
                      message: ambassador.messages.build(
                        recipient_id: team.id,
                        recipient_type: "Team",
                        regarding_id: pitch_event.id,
                        regarding_type: "RegionalPitchEvent"
                      ) %>
                  </div>
                </td>
                <td>
                  <%= link_to fa_icon('times', text: 'remove team'),
                    send(
                      "#{user.type_name}_regional_pitch_event_participation_path",
                      pitch_event,
                      participant_id: team.id,
                      participant_type: "Team",
                      referring_anchor: anchor,
                    ),
                    data: {
                      method: :delete,
                      confirm: "You are REMOVING #{team.name} from this event!",
                    } %>
                </td>
              <% end %>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <% if ambassador %>
              <td colspan="6">
            <% else %>
              <td colspan="2">
            <% end %>
              No teams are assigned in this event's <%= division.to_s.titleize %> division
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>
